{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=SELFIT_V4">

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="dashboard-card border-0 shadow-lg">
            
            <div class="card-header-brand d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-pencil-square"></i>
                    <h5 class="mb-0 fw-bold">È£ü‰∫ã„ÇíÁ∑®ÈõÜ</h5>
                </div>
                <small class="opacity-75 font-monospace">{{ meal.daily_record.date|date:"m/d" }}</small>
            </div>

            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                        <div class="alert alert-danger border-0 shadow-sm rounded-3 mb-4">
                            <i class="bi bi-exclamation-circle-fill me-2"></i>ÂÖ•ÂäõÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </div>
                    {% endif %}

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-muted">üïí È£ü‰∫ã„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞</label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for radio in form.meal_type %}
                                <div class="form-check form-check-inline m-0">
                                    {{ radio.tag }}
                                    <label class="btn btn-outline-light text-dark border-0 bg-white shadow-sm rounded-pill px-3 py-2 small" 
                                           for="{{ radio.id_for_label }}" style="cursor: pointer; min-width: 80px;">
                                        {{ radio.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4 p-4 rounded-4 text-center" style="background-color: #f8fafc; border: 2px dashed #cbd5e0;">
                        <label class="form-label text-dark fw-bold mb-3 d-block">üì∏ È£ü‰∫ã„ÅÆÂÜôÁúü</label>
                        
                        {% if meal.image %}
                            <div class="mb-4 position-relative d-inline-block">
                                <img src="{{ meal.image.url }}" class="rounded-3 shadow-sm border" style="max-height: 160px; object-fit: cover;">
                                <span class="badge bg-success position-absolute top-0 start-0 m-2 shadow-sm rounded-pill small">ÁèæÂú®„ÅÆÂÜôÁúü</span>
                            </div>
                        {% endif %}

                        <div class="d-none">
                            {{ form.image }}
                        </div>

                        <div class="row g-3 justify-content-center">
                            <div class="col-6">
                                <button type="button" class="btn btn-white w-100 py-2 rounded-4 shadow-sm border d-flex flex-column align-items-center gap-2 action-btn" 
                                        id="startCameraBtn">
                                    <div class="icon-circle bg-brand-light text-brand">
                                        <i class="bi bi-camera-fill fs-5"></i>
                                    </div>
                                    <span class="small fw-bold text-secondary">ÊíÆ„ÇäÁõ¥„Åô</span>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-white w-100 py-2 rounded-4 shadow-sm border d-flex flex-column align-items-center gap-2 action-btn" 
                                        onclick="document.querySelector('input[name=\'{{ form.image.name }}\']').click();">
                                    <div class="icon-circle bg-gray-light text-dark">
                                        <i class="bi bi-images fs-5"></i>
                                    </div>
                                    <span class="small fw-bold text-secondary">„Ç¢„É´„Éê„É†„Åã„Çâ</span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-3 text-center">
                            <img id="imagePreview" src="#" alt="„Éó„É¨„Éì„É•„Éº" 
                                class="img-fluid rounded-3 shadow-sm border mt-2"
                                style="display: none; max-height: 300px; max-width: 100%; object-fit: cover;">
                            <p class="small text-muted mt-2 mb-0" id="previewText" style="display: none;">‚ÄªÂ§âÊõ¥Âæå„ÅÆ„Ç§„É°„Éº„Ç∏</p>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-bold small text-muted">üìù „É°„É¢„ÉªË©≥Á¥∞</label>
                        {{ form.memo }}
                    </div>

                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-gradient btn-lg rounded-pill shadow-sm py-3 fw-bold">
                            Êõ¥Êñ∞„Åô„Çã
                        </button>
                        <a href="{% url 'records:index' %}" class="btn btn-link text-secondary text-decoration-none text-center small">
                            „Ç≠„É£„É≥„Çª„É´
                        </a>
                    </div>
                </form>

                <hr class="my-4 opacity-25">

                <div class="text-end">
                    <form action="{% url 'records:meal_delete' meal.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-soft-danger rounded-pill px-3 py-2 fw-bold"
                                onclick="return confirm('Êú¨ÂΩì„Å´„Åì„ÅÆÈ£ü‰∫ãË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªÂâäÈô§„Åô„Çã„Å®ÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ');">
                            <i class="bi bi-trash me-1"></i>„Åì„ÅÆÈ£ü‰∫ãË®òÈå≤„ÇíÂâäÈô§
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary py-2">
                <h6 class="modal-title"><i class="bi bi-camera-fill me-2"></i>È£ü‰∫ã„ÇíÊíÆÂΩ±</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0 position-relative bg-black">
                <video id="cameraVideo" autoplay playsinline style="width: 100%; max-height: 60vh; object-fit: contain;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>
            <div class="modal-footer border-secondary position-relative d-flex justify-content-center py-4 bg-dark">
                <button type="button" class="btn btn-outline-light rounded-circle position-absolute start-0 ms-4" 
                        id="switchCameraBtn" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-arrow-repeat fs-5"></i>
                </button>
                <button type="button" class="btn btn-light rounded-circle p-1 shadow" id="shutterBtn" style="width: 64px; height: 64px;">
                    <div class="w-100 h-100 bg-white rounded-circle border border-4 border-dark d-flex align-items-center justify-content-center">
                        <div style="width: 48px; height: 48px; background: #ff4757; border-radius: 50%;"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/meal_camera.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.querySelector('input[name="{{ form.image.name }}"]');
        const preview = document.getElementById('imagePreview');
        const previewText = document.getElementById('previewText');
        
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'inline-block';
                    if(previewText) previewText.style.display = 'block';
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    });
</script>

<style>
    .form-check-input { display: none; }
    .form-check-input:checked + label {
        background-color: #e6fffa !important;
        border: 2px solid #3bb2b8 !important;
        color: #2c7a7b !important;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(59, 178, 184, 0.2) !important;
    }
    .form-check-input + label {
        border: 2px solid transparent !important;
        transition: all 0.2s;
    }
    
    .action-btn {
        transition: transform 0.2s, background-color 0.2s;
        background-color: #fff;
    }
    .action-btn:active {
        transform: scale(0.98);
        background-color: #f8f9fa;
    }
    
    .icon-circle {
        width: 48px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 4px;
    }
    .bg-brand-light { background-color: rgba(59, 178, 184, 0.1); }
    .text-brand { color: #3bb2b8; }
    .bg-gray-light { background-color: #f1f3f5; }

    /* „ÇΩ„Éï„Éà„Å™ÂâäÈô§„Éú„Çø„É≥ */
    .btn-soft-danger {
        background-color: #fff5f5;
        color: #dc3545;
        border: 1px solid #feb2b2;
        transition: all 0.2s;
    }
    .btn-soft-danger:hover {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }
</style>
{% endblock %}