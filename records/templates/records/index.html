{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script>
        window.CHART_DATA = {
            dates: {{ dates_json|safe }},
            weights: {{ weights_json|safe }},
            bodyFats: {{ body_fats_json|safe }},
            emojis: {{ condition_emojis_json|safe }},
            ranges: {{ date_ranges_json|safe }},
            hasPhotos: {{ has_photos_json|safe }},
        };
        window.CHART_HEALTHY_RANGE = {{ healthy_range_json|safe }};
        window.CHART_TARGET_WEIGHT = {{ target_weight|default:"null" }};
        window.CHART_INTERVAL = "{{ interval_value }}";
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    {% if dates_json != "[]" %}
    <script src="{% static 'js/chart_logic.js' %}?v=5"></script>
    {% endif %}

    <link rel="stylesheet" href="{% static 'css/chart.css' %}?v=3">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=SELFIT_V2">

    <div class="container py-4" style="max-width: 900px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <div>
                <h2 class="fw-bold m-0 text-dark">Dashboard</h2>
                <p class="text-muted small m-0">‰ªäÊó•„ÅÆÈÄ≤Êçó„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ</p>
            </div>
            <a href="{% url 'records:add' %}" class="btn-fab-main text-decoration-none">
                <i class="bi bi-plus-lg"></i> Ë®òÈå≤„Çí„Å§„Åë„Çã
            </a>
        </div>

        <div class="row mb-4 g-2 g-md-4">
            <div class="col-4">
                <div class="dashboard-card p-2 p-md-4 d-flex flex-column justify-content-center align-items-center text-center h-100">
                    <span class="summary-label">CURRENT WEIGHT</span>
                    <div class="summary-value">
                        {% if summary.current_weight %}
                            {{ summary.current_weight }}<span class="summary-unit">kg</span>
                        {% else %}
                            --<span class="summary-unit">kg</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="dashboard-card p-2 p-md-4 d-flex flex-column justify-content-center align-items-center text-center h-100">
                    <span class="summary-label">GOAL WEIGHT</span>
                    <div class="summary-value">
                        {% if target_weight %}
                            {{ target_weight }}<span class="summary-unit">kg</span>
                        {% else %}
                            --<span class="summary-unit">kg</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="dashboard-card p-2 p-md-4 d-flex flex-column justify-content-center align-items-center text-center h-100">
                    <span class="summary-label">TOTAL CHANGE</span>
                    <div class="summary-value {% if summary.change_sign == '-' %}text-success{% elif summary.change_sign == '+' %}text-danger{% endif %}">
                        {% if summary.total_change is not None %}
                            {{ summary.change_sign }}{{ summary.total_change }}<span class="summary-unit">kg</span>
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card mb-4">
            <div class="card-header-brand d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-fire"></i> ‰ªäÊó•„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥
                </div>
                <small class="opacity-75 font-monospace">{{ today|date:"Y.m.d" }}</small>
            </div>
            <div class="list-group list-group-flush">
                {% for mission in daily_missions %}
                <div class="mission-list-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <h6 class="mb-0 fw-bold text-dark">{{ mission.title }}</h6>
                            <span class="badge bg-light text-secondary border rounded-pill" style="font-weight: 500; font-size: 0.7rem;">
                                Lv.{{ mission.difficulty }}
                            </span>
                        </div>
                        <small class="text-muted d-block" style="font-size: 0.85rem;">
                            {{ mission.description|truncatechars:40 }}
                        </small>
                    </div>
                    
                    {% if mission.id in completed_ids %}
                        <span class="text-success fw-bold d-flex align-items-center justify-content-center gap-1 mission-status">
                            <i class="bi bi-check-circle-fill"></i> <span>ÂÆå‰∫Ü</span>
                        </span>
                    {% else %}
                        <a href="{% url 'missions:complete' mission.id %}" class="btn-achieve">
                            ÈÅîÊàê
                        </a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-cup-hot mb-2 d-block fs-4"></i>
                    <p class="small mb-0">‰ªäÊó•„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>„ÇÜ„Å£„Åè„Çä‰ºë„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="dashboard-card mb-4" id="chart-section">
            <div class="card-header-clean">
                <div class="d-flex align-items-center gap-2 text-nowrap">
                    <span class="text-brand fs-5"><i class="bi bi-graph-up-arrow"></i></span>
                    <span>‰ΩìÈáç„ÅÆÊé®Áßª</span>
                </div>
                
                <div class="d-flex gap-1">
                    <button type="button" class="btn-zoom active zoom-btn" data-zoom="7">7Êó•</button>
                    <button type="button" class="btn-zoom zoom-btn" data-zoom="14">14Êó•</button>
                    <button type="button" class="btn-zoom zoom-btn" data-zoom="30">30Êó•</button>
                    <button type="button" class="btn-zoom zoom-btn" data-zoom="all">ÂÖ®ÊúüÈñì</button>
                </div>
            </div>

            <div class="chart-controls">
                <form method="get" class="row g-2 align-items-center justify-content-end">
                    <div class="col-auto d-flex align-items-center bg-white rounded-pill border shadow-sm date-picker-container">
                        <i class="bi bi-calendar-range text-muted date-picker-icon"></i>
                        <input type="date" name="graph_start" value="{{ graph_start_value }}" class="form-control-plaintext form-control-sm p-0 text-secondary fw-bold date-input">
                        <span class="text-muted small date-separator">„Äú</span>
                        <input type="date" name="graph_end" value="{{ graph_end_value }}" class="form-control-plaintext form-control-sm p-0 text-secondary fw-bold date-input">
                    </div>

                    <div class="col-auto">
                        <select name="interval" class="form-select form-select-sm py-2" style="min-width: 120px;">
                            <option value="daily" {% if interval_value == 'daily' %}selected{% endif %}>Êó•Ê¨°</option>
                            <option value="weekly" {% if interval_value == 'weekly' %}selected{% endif %}>ÈÄ±Ê¨°(Âπ≥Âùá)</option>
                            <option value="monthly" {% if interval_value == 'monthly' %}selected{% endif %}>ÊúàÊ¨°(Âπ≥Âùá)</option>
                        </select>
                    </div>

                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-update-brand rounded-pill px-3 py-2">Êõ¥Êñ∞</button>
                    </div>
                </form>
            </div>

            <div class="card-body p-4">
                {% if dates_json == "[]" %}
                <div class="text-center py-5 my-4 rounded-4" style="background-color: #f8fafc; border: 2px dashed #e2e8f0;">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center bg-white rounded-circle shadow-sm" style="width: 80px; height: 80px;">
                            <i class="bi bi-bar-chart-line" style="font-size: 2.5rem; color: #3bb2b8;"></i>
                        </div>
                    </div>
                    <h5 class="fw-bold text-dark mb-2">„Éá„Éº„Çø„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</h5>
                    <p class="text-muted small mb-4">„Åæ„Åö„ÅØ‰ªäÊó•„ÅÆË®òÈå≤„ÇíÁôªÈå≤„Åó„Å¶„ÄÅ<br>„Ç∞„É©„Éï„ÅßÂ§âÂåñ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                    <a href="{% url 'records:add' %}" class="btn btn-gradient rounded-pill px-4 py-2 shadow-sm fw-bold" style="background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); border: none; color: white;">
                        <i class="bi bi-plus-lg me-1"></i> ‰ªäÊó•„ÅÆË®òÈå≤„Çí„Å§„Åë„Çã
                    </a>
                </div>
                {% else %}
                <div class="d-flex justify-content-end align-items-center gap-3 mb-3">
                    <div class="d-flex align-items-center gap-1">
                        <span style="width:8px; height:8px; background-color:#ff9f43; border-radius:50%;"></span>
                        <small class="text-muted" style="font-size: 0.75rem;">‰ΩìÈáç</small>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span style="width:8px; height:8px; background-color:#4dabf7; border-radius:50%;"></span>
                        <small class="text-muted" style="font-size: 0.75rem;">‰ΩìËÑÇËÇ™</small>
                    </div>
                </div>

                <div class="chart-grid-lock">
                    <div class="chart-scroll-wrapper">
                        <div class="chart-body"> 
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex align-items-center gap-2 mb-4" id="recent-records-section" style="scroll-margin-top: 100px;">
            <h5 class="fw-bold text-dark m-0">Recent Records</h5>
            <div class="flex-grow-1 border-bottom"></div>
        </div>
        
        {% if not records %}
            <div class="text-center py-5">
                <div class="mb-3 text-muted opacity-50">
                    <i class="bi bi-journal-album" style="font-size: 3rem;"></i>
                </div>
                <p class="text-muted small">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>Âè≥‰∏ä„ÅÆ„Éú„Çø„É≥„Åã„ÇâÊúÄÂàù„ÅÆË®òÈå≤„Çí„Å§„Åë„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
            </div>
        {% endif %}

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            {% for record in records %}
            <div class="col" id="record-{{ record.date|date:'Y-m-d' }}">
                <div class="dashboard-card h-100">
                    <div style="cursor: pointer; position: relative;" data-bs-toggle="modal" data-bs-target="#detailModal-{{ record.id }}">
                        {% if record.photo %}
                            <img src="{{ record.photo.url }}" class="record-card-img" alt="Ë®òÈå≤ÂÜôÁúü">
                        {% else %}
                            <div class="bg-light text-center py-5 text-muted d-flex align-items-center justify-content-center record-card-img">
                                <i class="bi bi-image text-muted opacity-25 fs-1"></i>
                            </div>
                        {% endif %}
                        
                        <div class="record-date-badge">
                            {{ record.date|date:"m/d" }} <span class="small opacity-75">{{ record.date|date:"(D)" }}</span>
                        </div>
                    </div>

                    <div class="p-3 d-flex flex-column h-100">
                        <div class="d-flex justify-content-between align-items-end mb-2">
                            <div>
                                {% if record.weight %}
                                    <span class="fs-5 fw-bold text-dark">{{ record.weight }}</span>
                                    <span class="small text-muted">kg</span>
                                {% else %}
                                    <span class="text-muted small">-- kg</span>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-1">
                                {% for tag in record.conditions.all %}
                                    <span class="small" title="{{ tag.name }}">{{ tag.icon }}</span>
                                {% endfor %}
                            </div>
                        </div>

                        <p class="text-muted small flex-grow-1 text-truncate mb-3" style="min-height: 1.2em;">
                            {{ record.note|default:"" }}
                        </p>

                        <div class="d-flex justify-content-end border-top pt-2 mt-auto">
                            <a href="{% url 'records:edit' record.id %}" class="btn btn-sm btn-light text-secondary rounded-pill px-3">
                                <i class="bi bi-pencil-fill" style="font-size: 0.7rem;"></i> Á∑®ÈõÜ
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="detailModal-{{ record.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered position-relative">
                    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ (modal-content„ÅÆÂ§ñ„Å´ÈÖçÁΩÆ) -->
                    <button type="button" class="btn btn-light rounded-circle shadow js-modal-nav modal-nav-prev" data-direction="prev">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-light rounded-circle shadow js-modal-nav modal-nav-next" data-direction="next">
                        <i class="bi bi-chevron-right"></i>
                    </button>

                    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; position: relative; overflow: hidden;">
                        <div class="modal-header border-0 pb-0">
                            <h5 class="modal-title fw-bold text-dark">{{ record.date|date:"YÂπ¥mÊúàdÊó•" }} <span class="fs-6 text-brand ms-2">{{ record.date|date:"(D)" }}</span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body pt-3 pb-4 px-4">
                            <!-- 1. ÁîªÂÉè -->
                            {% if record.photo %}
                                <div class="mb-4 text-center">
                                    <img src="{{ record.photo.url }}" class="img-fluid rounded-4 shadow-sm w-100" style="max-height: 350px; object-fit: cover;">
                                </div>
                            {% endif %}

                            <!-- 2. Êï∞ÂÄ§ -->
                            <div class="row text-center mb-4 g-3">
                                <div class="col-6">
                                    <div class="p-3 rounded-4 border border-brand-light bg-brand-light h-100 d-flex flex-column justify-content-center">
                                        <small class="text-brand fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">WEIGHT</small>
                                        <div class="fw-bold text-dark" style="font-size: 1.5rem;">{{ record.weight|default:"--" }}<span class="fs-6 fw-normal text-brand ms-1">kg</span></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded-4 border border-brand-light bg-brand-light h-100 d-flex flex-column justify-content-center">
                                        <small class="text-brand fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">BODY FAT</small>
                                        <div class="fw-bold text-dark" style="font-size: 1.5rem;">{{ record.body_fat|default:"--" }}<span class="fs-6 fw-normal text-brand ms-1">%</span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„Çø„Ç∞ -->
                            {% if record.conditions.all %}
                            <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center">
                                {% for tag in record.conditions.all %}
                                    <span class="badge bg-white border text-secondary rounded-pill px-3 py-2 shadow-sm">
                                        {{ tag.icon }} {{ tag.name }}
                                    </span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if record.note %}
                                <div class="p-3 bg-light rounded-3 text-secondary small mb-4">
                                    {{ record.note|linebreaksbr }}
                                </div>
                            {% endif %}

                            <!-- 4. È£ü‰∫ã -->
                            <div class="d-flex justify-content-between align-items-center mb-3 border-top pt-3">
                                <h6 class="fw-bold m-0 text-secondary" style="font-size: 0.9rem;"><i class="bi bi-cup-hot me-2"></i>È£ü‰∫ã„ÅÆË®òÈå≤</h6>
                                <a href="{% url 'records:add_meal' record.id %}" class="btn btn-sm rounded-pill px-3 text-white" style="background-color: #3bb2b8; border: none;">
                                    <i class="bi bi-plus-lg"></i> ËøΩÂä†
                                </a>
                            </div>

                            <div class="vstack gap-2">
                                {% for meal in record.meal_set.all %}
                                    <div class="d-flex align-items-center gap-3 p-2 border rounded-3 bg-white">
                                        {% if meal.photo %}
                                            <img src="{{ meal.photo.url }}" class="rounded-3" style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded-3 d-flex align-items-center justify-content-center text-muted" style="width: 50px; height: 50px;">
                                                <i class="bi bi-cup-straw small"></i>
                                            </div>
                                        {% endif %}
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <div class="fw-bold text-dark text-truncate">{{ meal.menu|default:"(„É°„Éã„É•„ÉºÂêç„Å™„Åó)" }}</div>
                                            <div class="small text-muted">
                                                {{ meal.calorie|default:"--" }} kcal
                                                {% if meal.meal_type %}
                                                    <span class="ms-1">‚Ä¢ {{ meal.get_meal_type_display }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <a href="{% url 'records:meal_edit' meal.id %}" class="btn btn-sm btn-light text-secondary rounded-circle">
                                            <i class="bi bi-pencil-fill" style="font-size: 0.7rem;"></i>
                                        </a>
                                    </div>
                                {% empty %}
                                    <div class="text-center text-muted py-4 border border-dashed rounded-3 bg-light small">
                                        È£ü‰∫ã„ÅÆË®òÈå≤„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-between">
                            <form action="{% url 'records:delete' record.id %}" method="post" onsubmit="return confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-link text-danger text-decoration-none small">„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§</button>
                            </form>
                            <a href="{% url 'records:edit' record.id %}" class="btn btn-brand rounded-pill px-4 shadow-sm">Á∑®ÈõÜ„Åô„Çã</a>
                        </div>
                    </div>
                </div>
             </div>

            {% endfor %}
        </div>

                {% if records.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4 mb-4">
                <ul class="pagination justify-content-center">
                    {% if records.has_previous %}
                        <li class="page-item">
                            <a class="page-link rounded-circle d-flex align-items-center justify-content-center mx-1 shadow-sm border-0 text-dark" 
                               href="?page={{ records.previous_page_number }}#recent-records-section" style="width: 40px; height: 40px;">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item disabled">
                        <span class="page-link border-0 bg-transparent text-muted d-flex align-items-center" style="height: 40px;">
                            {{ records.number }} / {{ records.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if records.has_next %}
                        <li class="page-item">
                            <a class="page-link rounded-circle d-flex align-items-center justify-content-center mx-1 shadow-sm border-0 text-dark" 
                               href="?page={{ records.next_page_number }}#recent-records-section" style="width: 40px; height: 40px;">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

        <div class="dashboard-card mt-4 mb-4 border-0" style="background: linear-gradient(135deg, #fff8f0 0%, #fffbf5 100%); border-left: 5px solid #f6ad55 !important;">
            <div class="card-body p-4">
                <div class="d-flex align-items-start gap-3">
                    <div class="rounded-circle bg-white shadow-sm d-flex align-items-center justify-content-center flex-shrink-0" style="width: 56px; height: 56px;">
                        <span class="fs-3">üí°</span>
                    </div>
                    <div>
                        <h6 class="fw-bold text-warning mb-2" style="letter-spacing: 0.1em; color: #ed8936 !important;">DAILY HEALTH TIP</h6>
                        <p class="fw-bold text-dark mb-1 fs-5" id="health-tip-content">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                        <small class="text-muted">ÂÅ•Â∫∑ÁöÑ„Å™ÁîüÊ¥ª„ÅÆ„Åü„ÇÅ„ÅÆ„ÉØ„É≥„Éù„Ç§„É≥„Éà„Ç¢„Éâ„Éê„Ç§„Çπ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    <script src="{% static 'js/form_validation.js' %}"></script>
    <!-- <script src="{% static 'js/scroll_helper.js' %}"></script>   -->
    
    <!-- ÂãïÁöÑ„É¢„Éº„ÉÄ„É´Ë°®Á§∫Áî®„ÅÆ„Ç≥„É≥„ÉÜ„Éä -->
    <div id="dynamic-modal-container"></div>

    <!-- ÁõÆÊ®ôÈÅîÊàê„ÅäÁ•ù„ÅÑ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="goalAchievedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center border-0 shadow-lg" style="background: linear-gradient(135deg, #fff 0%, #f0f9ff 100%); border-radius: 20px;">
                <div class="modal-body p-5">
                    <div class="mb-4">
                        <i class="bi bi-trophy-fill text-warning" style="font-size: 4rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));"></i>
                    </div>
                    <h2 class="fw-bold text-dark mb-3">Congratulations!</h2>
                    <p class="text-muted mb-4">
                        ÁõÆÊ®ô‰ΩìÈáç„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ<br>
                        „ÅÇ„Å™„Åü„ÅÆÂä™Âäõ„ÅåÂÆü„ÇíÁµê„Å≥„Åæ„Åó„Åü„Å≠‚ú®
                    </p>
                    <button type="button" class="btn btn-primary rounded-pill px-5 py-2 fw-bold shadow-sm" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); border: none;">
                        Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            {% if 'goal_achieved_event' in message.tags %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // 1. „ÅäÁ•ù„ÅÑ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                        var goalModalEl = document.getElementById('goalAchievedModal');
                        if (goalModalEl) {
                            var goalModal = new bootstrap.Modal(goalModalEl);
                            goalModal.show();
                        }

                        // 2. Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„Éà (Â∑¶Âè≥„Åã„ÇâÁô∫Â∞Ñ)
                        var duration = 3 * 1000;
                        var end = Date.now() + duration;

                        (function frame() {
                            confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#3bb2b8', '#42e695', '#ff9f43'] });
                            confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#3bb2b8', '#42e695', '#ff9f43'] });

                            if (Date.now() < end) requestAnimationFrame(frame);
                        }());
                    });
                </script>
            {% endif %}
        {% endfor %}
    {% endif %}

    <style>
        .btn-zoom.active {
            background-color: #3bb2b8 !important;
            color: white !important;
            border-color: #3bb2b8 !important;
        }
        .btn-update-brand {
            background-color: #3bb2b8;
            border-color: #3bb2b8;
            color: white;
        }
        .btn-update-brand:hover {
            background-color: #2c7a7b;
            border-color: #2c7a7b;
            color: white;
        }
        .text-brand { color: #3bb2b8 !important; }
        .bg-brand-light { background-color: rgba(59, 178, 184, 0.08) !important; }
        .border-brand-light { border-color: rgba(59, 178, 184, 0.2) !important; }
        .btn-brand {
            background-color: #3bb2b8;
            color: white;
            border: none;
        }
        .btn-brand:hover {
            background-color: #2c7a7b;
            color: white;
        }

        /* „É¢„Éº„ÉÄ„É´Áü¢Âç∞„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .modal-nav-prev, .modal-nav-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2000;
            width: 48px;
            height: 48px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
        }
        /* PC„Å™„Å©Â∫É„ÅÑÁîªÈù¢„Åß„ÅØÂ§ñÂÅ¥„Å´Âá∫„Åô„ÉªËÉåÊôØ„Å™„Åó */
        @media (min-width: 768px) {
            .modal-nav-prev { left: -70px; }
            .modal-nav-next { right: -70px; }
            
            .modal-nav-prev, .modal-nav-next {
                background-color: transparent !important;
                border: none !important;
                box-shadow: none !important;
                color: rgba(255, 255, 255, 0.6) !important;
            }
            .modal-nav-prev:hover, .modal-nav-next:hover {
                color: #fff !important;
                background-color: rgba(255, 255, 255, 0.1) !important;
                transform: translateY(-50%) scale(1.1);
            }
        }
        /* „Çπ„Éû„Éõ„Å™„Å©Áã≠„ÅÑÁîªÈù¢„Åß„ÅØ„É¢„Éº„ÉÄ„É´„ÅÆ‰∏ãÂÅ¥„Å´ÈÖçÁΩÆ„ÉªËÉåÊôØ„ÅÇ„Çä */
        @media (max-width: 767.98px) {
            .modal-nav-prev, .modal-nav-next {
                top: auto;
                bottom: -50px;
                transform: none;
                
                /* ËÉåÊôØ„ÅÇ„Çä */
                background-color: #fff !important;
                border: 1px solid #eee !important;
                box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important;
                color: #555 !important;
            }
            .modal-nav-prev:hover, .modal-nav-next:hover {
                background-color: #f8f9fa !important;
                transform: scale(1.1);
            }
            .modal-nav-prev { left: 30%; }
            .modal-nav-next { right: 30%; left: auto; }
            .modal-nav-prev i, .modal-nav-next i { font-size: 1.5rem; }
        }

        /* „Ç∞„É©„Éï„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆÊó•‰ªòÂÖ•ÂäõÊ¨ÑË™øÊï¥ */
        .date-picker-container {
            padding: 0.5rem 1rem;
        }
        .date-picker-icon {
            margin-right: 1rem;
        }
        .date-input {
            width: 110px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .date-separator {
            margin: 0 0.5rem;
        }

        /* „Çπ„Éû„ÉõÁîªÈù¢Áî®Ë™øÊï¥ */
        @media (max-width: 576px) {
            html {
                font-size: 14px; /* ÂÖ®‰Ωì„ÅÆÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è */
            }
            .date-picker-container {
                padding: 0.3rem 0.8rem; /* „Éë„Éá„Ç£„É≥„Ç∞„ÇíÁ∏ÆÂ∞è */
            }
            .date-picker-icon {
                margin-right: 0.5rem; /* „Ç¢„Ç§„Ç≥„É≥„ÅÆÈñìÈöî„ÇíÁ∏ÆÂ∞è */
                font-size: 0.9rem;
            }
            .date-input {
                width: 85px; /* ÂÖ•ÂäõÊ¨Ñ„ÅÆÂπÖ„ÇíÁ∏ÆÂ∞è */
                font-size: 0.75rem; /* ÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è */
            }
            .date-separator {
                margin: 0 0.2rem;
            }

            /* „Ç∞„É©„ÉïÊúüÈñìÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíÂ∞è„Åï„Åè */
            .btn-zoom {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.65rem !important;
                padding: 0 !important;
            }

            /* „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ„ÅÆÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥ */
            .summary-label {
                font-size: 0.55rem !important;
                white-space: nowrap;
            }
            .summary-value {
                font-size: 1.4rem !important;
            }
            .summary-unit {
                font-size: 0.7rem !important;
            }
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàê„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Áµ±‰∏Ä */
        .btn-achieve {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 1.2rem;
            background: white;
            color: #3bb2b8 !important;
            border: 1px solid #3bb2b8;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.85rem;
            text-decoration: none;
            box-shadow: 0 2px 6px rgba(59, 178, 184, 0.1);
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 80px;
        }
        .btn-achieve:hover {
            background: #3bb2b8;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 178, 184, 0.4);
        }
        .mission-status {
            min-width: 80px;
        }

        /* „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ„ÅÆÊï∞ÂÄ§ÔºàPC„Éá„Éï„Ç©„É´„ÉàÔºâ */
        .summary-value {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1.2;
        }
        .summary-unit {
            font-size: 1rem;
            font-weight: 600;
        }
    </style>

{% endblock %}